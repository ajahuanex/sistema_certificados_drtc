name: Docker Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  docker-integration-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Cache Docker layers
      uses: actions/cache@v3
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: Build Docker images
      run: |
        docker-compose -f docker-compose.test.yml build

    - name: Start test services
      run: |
        docker-compose -f docker-compose.test.yml up -d test-db test-redis
        sleep 10

    - name: Wait for PostgreSQL
      run: |
        docker-compose -f docker-compose.test.yml exec -T test-db pg_isready -U test_user -d test_certificados

    - name: Wait for Redis
      run: |
        docker-compose -f docker-compose.test.yml exec -T test-redis redis-cli ping

    - name: Run database migrations
      run: |
        docker-compose -f docker-compose.test.yml run --rm test-web python manage.py migrate --noinput

    - name: Run Docker integration tests
      run: |
        docker-compose -f docker-compose.test.yml run --rm test-web python manage.py test certificates.tests.test_docker_integration --verbosity=2

    - name: Test database connection
      run: |
        docker-compose -f docker-compose.test.yml run --rm test-web python manage.py shell -c "
        from django.db import connection
        connection.ensure_connection()
        print('✓ Database connection successful')
        "

    - name: Test Redis connection
      run: |
        docker-compose -f docker-compose.test.yml run --rm test-web python manage.py shell -c "
        from django.core.cache import cache
        cache.set('ci_test', 'value', 10)
        assert cache.get('ci_test') == 'value'
        print('✓ Redis connection successful')
        "

    - name: Test data persistence
      run: |
        docker-compose -f docker-compose.test.yml run --rm test-web python manage.py shell -c "
        from django.contrib.auth.models import User
        User.objects.create_user('ci_test', 'ci@test.com', 'testpass')
        print('✓ Data created')
        "
        docker-compose -f docker-compose.test.yml restart test-web
        sleep 5
        docker-compose -f docker-compose.test.yml run --rm test-web python manage.py shell -c "
        from django.contrib.auth.models import User
        user = User.objects.get(username='ci_test')
        print(f'✓ Data persisted: {user.username}')
        "

    - name: Test health checks
      run: |
        docker-compose -f docker-compose.test.yml run --rm test-web python manage.py shell -c "
        from certificates.views.health_views import database_health_check, cache_health_check
        db = database_health_check()
        cache = cache_health_check()
        assert db['healthy'], 'Database health check failed'
        assert cache['healthy'], 'Cache health check failed'
        print('✓ All health checks passed')
        "

    - name: Collect test coverage (optional)
      if: always()
      run: |
        docker-compose -f docker-compose.test.yml run --rm test-web coverage run --source='certificates' manage.py test certificates.tests.test_docker_integration
        docker-compose -f docker-compose.test.yml run --rm test-web coverage report

    - name: Stop and remove containers
      if: always()
      run: |
        docker-compose -f docker-compose.test.yml down -v

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results
        path: |
          test-results/
          coverage.xml

  docker-compose-validation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Validate docker-compose.yml
      run: |
        docker-compose -f docker-compose.yml config

    - name: Validate docker-compose.prod.yml
      run: |
        docker-compose -f docker-compose.prod.yml config

    - name: Validate docker-compose.test.yml
      run: |
        docker-compose -f docker-compose.test.yml config

    - name: Check Dockerfile syntax
      run: |
        docker build --no-cache --target builder -f Dockerfile . || true

  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
