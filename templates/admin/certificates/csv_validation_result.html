{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Inicio</a>
    &rsaquo; <a href="{% url 'admin:certificates_participant_changelist' %}">Participantes</a>
    &rsaquo; <a href="{% url 'admin:certificates_participant_import_csv' %}">Importar CSV</a>
    &rsaquo; Resultado de Validación
</div>
{% endblock %}

{% block content %}
<div id="content-main">
    <h1>{{ title }}</h1>
    
    {% if is_valid %}
    <div class="module" style="margin-bottom: 20px; padding: 15px; background-color: #d4edda; border-left: 4px solid #28a745;">
        <h2 style="margin-top: 0; color: #155724;">✓ Validación Exitosa</h2>
        <p>El archivo CSV es válido y está listo para importarse.</p>
        <p><strong>Total de filas válidas:</strong> {{ total_rows }}</p>
    </div>
    {% else %}
    <div class="module" style="margin-bottom: 20px; padding: 15px; background-color: #f8d7da; border-left: 4px solid #dc3545;">
        <h2 style="margin-top: 0; color: #721c24;">✗ Validación Fallida</h2>
        <p>Se encontraron errores en el archivo CSV. Por favor corrígelos antes de importar.</p>
    </div>
    {% endif %}
    
    {% if messages %}
    <div class="module" style="margin-bottom: 20px;">
        <h3>Mensajes de Validación:</h3>
        <ul style="max-height: 400px; overflow-y: auto; background-color: #f5f5f5; padding: 15px; border-radius: 4px;">
            {% for message in messages %}
            <li style="margin-bottom: 5px; {% if 'Error' in message or 'inválido' in message %}color: #dc3545;{% elif 'normalizará' in message %}color: #ffc107;{% else %}color: #28a745;{% endif %}">
                {{ message }}
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
    
    {% if validated_rows %}
    <div class="module" style="margin-bottom: 20px;">
        <h3>Vista Previa de Datos (primeras 10 filas):</h3>
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead style="background-color: #417690; color: white;">
                    <tr>
                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Fila</th>
                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">DNI</th>
                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Nombre</th>
                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Evento</th>
                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Fecha</th>
                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Tipo</th>
                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Estado</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in validated_rows|slice:":10" %}
                    <tr style="{% if not row.valid %}background-color: #f8d7da;{% elif row.warnings %}background-color: #fff3cd;{% else %}background-color: #d4edda;{% endif %}">
                        <td style="padding: 8px; border: 1px solid #ddd;">{{ row.row_number }}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">{{ row.data.dni|default:"-" }}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">{{ row.data.full_name|default:"-" }}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">{{ row.data.event_name|default:"-" }}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">{{ row.data.event_date|default:"-" }}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">{{ row.data.attendee_type|default:"-" }}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">
                            {% if row.valid %}
                            <span style="color: #28a745; font-weight: bold;">✓ Válido</span>
                            {% else %}
                            <span style="color: #dc3545; font-weight: bold;">✗ Error</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if validated_rows|length > 10 %}
        <p style="margin-top: 10px; color: #666;">
            <em>Mostrando las primeras 10 filas de {{ validated_rows|length }} total.</em>
        </p>
        {% endif %}
    </div>
    {% endif %}
    
    <div class="submit-row">
        {% if is_valid %}
        <form method="post" action="{% url 'admin:certificates_participant_import_csv' %}" enctype="multipart/form-data" style="display: inline;">
            {% csrf_token %}
            <input type="hidden" name="csv_file" value="{{ csv_file }}">
            <p style="margin-bottom: 15px; padding: 10px; background-color: #fff3cd; border-radius: 4px;">
                <strong>⚠️ Nota:</strong> Para importar el archivo, debes volver a subirlo sin marcar "Solo validar".
            </p>
        </form>
        {% endif %}
        <a href="{% url 'admin:certificates_participant_import_csv' %}" class="button">← Volver a Importar</a>
        <a href="{% url 'admin:certificates_participant_changelist' %}" class="button">Ir a Participantes</a>
    </div>
</div>
{% endblock %}
